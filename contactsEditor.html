<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type='text/javascript' src='knockout-3.5.1.js'></script>
    <title>Типы управления</title>
</head>
<body>
    <h2>Контакты</h2>
    <div id='contactsList'>
        <table class='contactsEditor'>
            <tr>
                <th>Имя</th>
                <th>Фамилия</th>
                <th>Номер</th>
            </tr>
            <tbody data-bind="foreach: contacts">
                <tr>
                    <td>
                        <input data-bind='value: firstName' />
                        <div><a href='#' data-bind='click: $root.removeContact'>удалить</a></div>
                    </td>
                    <td><input data-bind='value: lastName' /></td>
                    <td>
                        <table>
                            <tbody data-bind="foreach: phones">
                                <tr>
                                    <td><input data-bind='value: type' /></td>
                                    <td><input data-bind='value: number' /></td>
                                    <td><a href='#' data-bind='click: $root.removePhone'>удалить</a></td>
                                </tr>
                            </tbody>
                        </table>
                        <a href='#' data-bind='click: $root.addPhone'>добавить номер</a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <p>
        <button data-bind='click: addContact'>Добавить контакт</button>
        <button data-bind='click: save, enable: contacts().length > 0'>Сохранить в JSON</button>
    </p>
    
    <textarea data-bind='value: lastSavedJson' rows='5' cols='60' disabled='disabled'> </textarea> 
<script>
    var initialData = [
        { firstName: "Анна", lastName: "Мэрин", phones: [
            { type: "Мобильный", number: "(555) 121-2121" },
            { type: "Домашний", number: "(555) 123-4567"}]
        },
        { firstName: "Сенсей", lastName: "Отаку", phones: [
            { type: "Мобильный", number: "(555) 444-2222" },
            { type: "Домашний", number: "(555) 999-1212"}]
        }
    ];
    
    var ContactsModel = function(contacts) {
        var self = this;
        self.contacts = ko.observableArray(ko.utils.arrayMap(contacts, function(contact) {
            return { firstName: contact.firstName, lastName: contact.lastName, phones: ko.observableArray(contact.phones) };
        }));
    
        self.addContact = function() {
            self.contacts.push({
                firstName: "",
                lastName: "",
                phones: ko.observableArray()
            });
        };
    
        self.removeContact = function(contact) {
            self.contacts.remove(contact);
        };
    
        self.addPhone = function(contact) {
            contact.phones.push({
                type: "",
                number: ""
            });
        };
    
        self.removePhone = function(phone) {
            $.each(self.contacts(), function() { this.phones.remove(phone) })
        };
    
        self.save = function() {
            self.lastSavedJson(JSON.stringify(ko.toJS(self.contacts), null, 2));
        };
    
        self.lastSavedJson = ko.observable("")
    };
    
    ko.applyBindings(new ContactsModel(initialData));
   
</script>
<div>
</div>
</body>
</html>

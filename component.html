<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type='text/javascript' src='knockout-3.5.1.js'></script>
    <script type='text/javascript' src='jquery-2.1.1.js'></script>
   
    <title>Компоненты и пользовательские элементы</title>
</head>


<body>
    <ul data-bind="foreach: products">
        <li class="product">
            <strong data-bind="text: name"></strong>
            <like-widget params="value: userRating"></like-widget>
        </li>
    </ul>
    <button data-bind="click: addProduct">Добавить продукт</button>
    <button data-bind="click: dispose">Остановить ЖЦ</button>

    <h4>Без параметров</h4>
    <div data-bind='component: "message-editor"'></div>
    <h4>С параметрами</h4>
    <div data-bind='component: {
        name: "message-editor",
        params: { initialText: "Ку-ку"}
    }'></div>
    <h4>Виртуальные элементы:</h4>
    <!-- ko component: "message-editor" --><!-- /ko -->
    <!-- ko component: {
        name: "message-editor",
        params: { initialText: "В.Э. с параметрами", otherParam: 123 }
    } --><!-- /ko -->    

    <h4>Пользовательские элементы</h4>
    <message-editor></message-editor>   
    <message-editor params='initialText: "С параметрами"'></message-editor>


    <script>
        function Product(name, rating) {
            this.name = name;
            this.userRating = ko.observable(rating || null);
        };        
        function MyViewModel() {
            this.products = ko.observableArray();
            this.myComputed = ko.computed(function() {
                return someExternalObservable() + 1;
            }, this);
        
            this.myPureComputed = ko.pureComputed(function() {
                return someExternalObservable() + 2;
            }, this);
        
            this.mySubscription = someExternalObservable.subscribe(function(val) {
                console.log('Внешний наблюдаемый объект изменился на... ' + val);
            }, this);
        
            this.myIntervalHandle = window.setInterval(function() {
                console.log('+1 секунда жизни компонента.');
            }, 1000);
        };
        MyViewModel.prototype.addProduct = function() {
            var name = 'Продукт ' + (this.products().length + 1);
            this.products.push(new Product(name));
        };
        ko.components.register('like-widget', {
            viewModel: function(params) {
                this.chosenValue = params.value;
                // поведение
                this.like = function() { this.chosenValue('нравится'); }.bind(this);
                this.dislike = function() { this.chosenValue('не нравится'); }.bind(this);
            },
            template:
                '<div class="like-or-dislike" data-bind="visible: !chosenValue()">\
                    <button data-bind="click: like">Нравится</button>\
                    <button data-bind="click: dislike">Не нравится</button>\
                </div>\
                <div class="result" data-bind="visible: chosenValue">\
                    Тебе <strong data-bind="text: chosenValue"></strong> это\
                </div>'
        }); 

        ko.components.register('message-editor',{
            viewModel: function(params){
                this.text = ko.observable(params && params.initialText || '');
            },
            template: 
                'Сообщение: <input data-bind="value: text"/>'
                +'(length: <span data-bind="text: text().length"></span>)'
        });


        var someExternalObservable = ko.observable(123);
 
        MyViewModel.prototype.dispose = function() {
            this.myComputed.dispose();
            this.mySubscription.dispose();
            window.clearInterval(this.myIntervalHandle);
        }
        ko.components.register('your-component-name', {
            viewModel: MyViewModel,
            template: 'some-template'
        });
        
        ko.applyBindings(new MyViewModel());

    </script>    
</body>
</html>